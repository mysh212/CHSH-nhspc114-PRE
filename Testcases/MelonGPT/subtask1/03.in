How can I optimize the performance of this code?
